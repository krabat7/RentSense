#!/bin/bash
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–µ—Ä–∞ —á–µ—Ä–µ–∑ docker (–±–µ–∑ docker-compose)

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë    –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ü–ê–†–°–ï–†–ê                         ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

cd /root/rentsense || exit 1

echo "üîÑ –°–¢–ê–¢–£–° –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
docker ps --filter "name=parser" --format "table {{.Names}}\t{{.Status}}\t{{.State}}" 2>/dev/null
echo ""

# –ù–∞—Ö–æ–¥–∏–º –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–∞—Ä—Å–µ—Ä–∞
CONTAINER_NAME=$(docker ps --filter "name=parser" --format "{{.Names}}" | head -1)

if [ -z "$CONTAINER_NAME" ]; then
    echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–∞—Ä—Å–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo ""
    echo "–í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
    docker ps --format "table {{.Names}}\t{{.Status}}"
    exit 1
fi

echo "üì¶ –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞: $CONTAINER_NAME"
echo ""

echo "üìã –ü–û–°–õ–ï–î–ù–ò–ï 30 –°–¢–†–û–ö –õ–û–ì–û–í:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
timeout 10 docker logs --tail 30 "$CONTAINER_NAME" 2>&1 || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ (—Ç–∞–π–º–∞—É—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞)"
echo ""

echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 500 —Å—Ç—Ä–æ–∫):"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
added=$(timeout 10 docker logs --tail 500 "$CONTAINER_NAME" 2>&1 | grep -c "is adding" 2>/dev/null || echo "0")
status200=$(timeout 10 docker logs --tail 500 "$CONTAINER_NAME" 2>&1 | grep -c "Status=200" 2>/dev/null || echo "0")
timeouts=$(timeout 10 docker logs --tail 500 "$CONTAINER_NAME" 2>&1 | grep -c "Timeout.*exceeded" 2>/dev/null || echo "0")
status403=$(timeout 10 docker logs --tail 500 "$CONTAINER_NAME" 2>&1 | grep -c "Status=403" 2>/dev/null || echo "0")
cycles=$(timeout 10 docker logs --tail 500 "$CONTAINER_NAME" 2>&1 | grep -c "–ù–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞" 2>/dev/null || echo "0")

echo "  ‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: $added"
echo "  ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (200): $status200"
echo "  ‚è±Ô∏è  –¢–∞–π–º–∞—É—Ç–æ–≤: $timeouts"
echo "  üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ 403: $status403"
echo "  üîÑ –¶–∏–∫–ª–æ–≤ –ø–∞—Ä—Å–∏–Ω–≥–∞: $cycles"
echo ""

if [ "$added" -gt 0 ] 2>/dev/null; then
    echo "‚úÖ –ü–û–°–õ–ï–î–ù–ò–ï 3 –î–û–ë–ê–í–õ–ï–ù–ù–´–• –û–ë–™–Ø–í–õ–ï–ù–ò–Ø:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    timeout 10 docker logs --tail 500 "$CONTAINER_NAME" 2>&1 | grep "is adding" | tail -3 | sed 's/^/  /'
    echo ""
fi

echo "‚è±Ô∏è  –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –û –¶–ò–ö–õ–ê–•:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
timeout 10 docker logs --tail 200 "$CONTAINER_NAME" 2>&1 | grep -E "(–ù–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞|–¶–∏–∫–ª.*–∑–∞–≤–µ—Ä—à–µ–Ω|–ø–∞—É–∑–∞.*—Å–µ–∫—É–Ω–¥)" | tail -5 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ"
echo ""

