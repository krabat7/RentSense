#!/bin/bash
# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∫—Å–∏ –∏ –ø–∞—Ä—Å–µ—Ä–∞ (–±–µ–∑ –¥–æ–ª–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë    –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–ê–†–°–ï–†–ê –ò –ü–†–û–ö–°–ò                        ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

cd /root/rentsense || exit 1

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 100 —Å—Ç—Ä–æ–∫ –ª–æ–≥–æ–≤
echo "üìã –ü–û–°–õ–ï–î–ù–ò–ï 20 –°–¢–†–û–ö –õ–û–ì–û–í:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
docker-compose -f docker-compose.prod.yml logs --tail 100 parser 2>/dev/null | tail -20
echo ""

# –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫)
echo "üìä –ë–´–°–¢–†–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000 —Å—Ç—Ä–æ–∫):"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

# –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–π restart)
restart_time=$(docker ps --format "{{.Status}}" --filter "name=rentsense_parser" 2>/dev/null | head -1 | grep -oP "Up \d+ \w+" || echo "")
echo "  ‚è±Ô∏è  –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: $restart_time"

added=$(docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep -c "is adding" 2>/dev/null || echo "0")
status200=$(docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep -c "Status=200" 2>/dev/null || echo "0")
timeouts=$(docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep -c "Timeout.*exceeded" 2>/dev/null || echo "0")
status403=$(docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep -c "Status=403" 2>/dev/null || echo "0")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∞–π–º–∞—É—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
last_timeout=$(docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep "Timeout.*exceeded" | tail -1 | cut -d'|' -f1 | xargs 2>/dev/null || echo "")

echo "  ‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: $added"
echo "  ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (200): $status200"
echo "  ‚è±Ô∏è  –¢–∞–π–º–∞—É—Ç–æ–≤: $timeouts"
if [ -n "$last_timeout" ]; then
    echo "     ‚îî‚îÄ –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–∞–π–º–∞—É—Ç: $last_timeout"
fi
echo "  üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–æ–∫ 403: $status403"
echo ""

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
if [ "$added" -gt 0 ] 2>/dev/null; then
    echo "‚úÖ –ü–û–°–õ–ï–î–ù–ò–ï 5 –î–û–ë–ê–í–õ–ï–ù–ù–´–• –û–ë–™–Ø–í–õ–ï–ù–ò–ô:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep "is adding" | tail -5 | sed 's/^/  /'
    echo ""
fi

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
if [ "$timeouts" -gt 0 ] 2>/dev/null || [ "$status403" -gt 0 ] 2>/dev/null; then
    echo "‚ö†Ô∏è  –ü–û–°–õ–ï–î–ù–ò–ï 5 –û–®–ò–ë–û–ö:"
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    docker-compose -f docker-compose.prod.yml logs --tail 1000 parser 2>/dev/null | grep -E "(Timeout|Status=40[37]|ERROR)" | tail -5 | sed 's/^/  /'
    echo ""
fi

# –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ docker ps)
echo "üîÑ –°–¢–ê–¢–£–° –ü–ê–†–°–ï–†–ê:"
echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
if docker ps --format "{{.Names}}" 2>/dev/null | grep -q "rentsense_parser"; then
    echo "  ‚úì –ü–∞—Ä—Å–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
    uptime=$(docker ps --format "{{.Status}}" --filter "name=rentsense_parser" 2>/dev/null | head -1)
    if [ -n "$uptime" ]; then
        echo "  ‚è±Ô∏è  –°—Ç–∞—Ç—É—Å: $uptime"
    fi
else
    echo "  ‚ùå –ü–∞—Ä—Å–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
fi
echo ""

echo "üí° –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./analyze_proxy_status.sh"

